<script>
  window.addEventListener("message", (event) => {
    const data = event.data;
    const map = window.myMap; // ton instance Leaflet créée ailleurs

    // Nettoie les anciens marqueurs si nécessaire
    if (window.currentMarkers) {
      window.currentMarkers.forEach(m => m.remove());
    }

    window.currentMarkers = data.pins.map(pin => {
      const [lat, lng] = pin.coord;
      const couleur = getColorByCode(pin.codeannonce);

      const marker = L.circleMarker([lat, lng], {
        radius: 10,
        fillColor: couleur,
        color: "#000",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      }).addTo(map);

      marker.bindPopup(`<strong>${pin.address}</strong>`);
      return marker;
    });

    map.setView(data.center, 6); // recentre la carte
  });

  function getColorByCode(code) {
    switch (code) {
      case "RR": return "#D2B48C"; // sable
      case "RC": return "#ADD8E6"; // bleu clair
      case "DR": return "#FFFFFF"; // blanc
      case "DC": return "#90EE90"; // vert clair
      default: return "#999999";   // gris par défaut
    }
  }
</script>
